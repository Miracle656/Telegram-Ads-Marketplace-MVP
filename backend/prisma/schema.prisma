// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CHANNEL_OWNER
  ADVERTISER
  BOTH
}

enum DealStatus {
  NEGOTIATING
  AWAITING_PAYMENT
  PAYMENT_RECEIVED
  CREATIVE_PENDING
  CREATIVE_REVIEW
  CREATIVE_APPROVED
  SCHEDULED
  POSTED
  VERIFYING
  COMPLETED
  CANCELLED
  REFUNDED
}

enum AdFormat {
  POST
  FORWARD
  REPOST
  STORY
  CUSTOM
}

enum CreativeStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REVISION_REQUESTED
  REJECTED
}

enum PaymentStatus {
  PENDING
  PAID
  RELEASED
  REFUNDED
}


model User {
  id                Int         @id @default(autoincrement())
  telegramId        BigInt      @unique
  username          String?
  firstName         String?
  lastName          String?
  role              UserRole    @default(BOTH)
  walletAddress     String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  ownedChannels     Channel[]
  campaigns         Campaign[]
  dealsAsOwner      Deal[]      @relation("OwnerDeals")
  dealsAsAdvertiser Deal[]      @relation("AdvertiserDeals")
  managedChannels   ChannelAdmin[]

  @@index([telegramId])
}

model Channel {
  id                Int         @id @default(autoincrement())
  telegramId        String      @unique
  telegramChannelId String      @unique
  title             String
  username          String?
  description       String?
  subscriberCount   Int         @default(0)
  averageViews      Int         @default(0)
  language          String?
  category          String?
  isPremium         Boolean     @default(false)
  botAdded          Boolean     @default(false)
  botIsAdmin        Boolean     @default(false)
  lastStatsUpdate   DateTime?
  lastVerified      DateTime?
  isActive          Boolean     @default(true)
  ownerId           Int
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  // Relations
  owner             User        @relation(fields: [ownerId], references: [id])
  admins            ChannelAdmin[]
  adFormats         ChannelAdFormat[]
  listings          ChannelListing[]
  applications      CampaignApplication[]
  deals             Deal[]
  posts             Post[]

  @@index([ownerId])
  @@index([telegramChannelId])
}

model ChannelAdmin {
  id          Int      @id @default(autoincrement())
  channelId   Int
  userId      Int
  canPost     Boolean  @default(true)
  canEdit     Boolean  @default(false)
  createdAt   DateTime @default(now())

  // Relations
  channel     Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id])

  @@unique([channelId, userId])
  @@index([userId])
}

model ChannelAdFormat {
  id          Int       @id @default(autoincrement())
  channelId   Int
  format      AdFormat
  price       Float
  description String?
  isAvailable Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  channel     Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
  @@unique([channelId, format])
}

model Campaign {
  id              Int      @id @default(autoincrement())
  title           String
  description     String
  budget          Float
  targetAudience  String?
  preferredFormats AdFormat[]
  isActive        Boolean  @default(true)
  advertiserId    Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  advertiser      User     @relation(fields: [advertiserId], references: [id])
  applications    CampaignApplication[]
  deals           Deal[]

  @@index([advertiserId])
}

model CampaignApplication {
  id           Int      @id @default(autoincrement())
  campaignId   Int
  channelId    Int
  proposedPrice Float
  message      String?
  status       String   @default("pending") // pending, accepted, rejected
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  campaign     Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  channel      Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([channelId])
  @@unique([campaignId, channelId])
}

model ChannelListing {
  id          Int      @id @default(autoincrement())
  channelId   Int      @unique
  minBudget   Float?
  targetNiches String[]
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  channel     Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId])
}

model Deal {
  id              Int         @id @default(autoincrement())
  channelId       Int
  channelOwnerId  Int
  advertiserId    Int
  campaignId      Int?
  status         DealStatus  @default(NEGOTIATING)
  agreedPrice     Float
  adFormat        AdFormat
  customFormatName String?
  brief           String?
  scheduledPostTime DateTime?
  completedAt     DateTime?
  lastActivityAt  DateTime    @default(now())
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  channel         Channel     @relation(fields: [channelId], references: [id])
  owner           User        @relation("OwnerDeals", fields: [channelOwnerId], references: [id])
  advertiser      User        @relation("AdvertiserDeals", fields: [advertiserId], references: [id])
  campaign        Campaign?   @relation(fields: [campaignId], references: [id])
  payment         Payment?
  creatives       Creative[]
  post            Post?

  @@index([channelOwnerId])
  @@index([advertiserId])
  @@index([status])
  @@index([lastActivityAt])
}

model Creative {
  id          Int             @id @default(autoincrement())
  dealId      Int
  content     String
  mediaUrls   String[]
  version     Int             @default(1)
  status      CreativeStatus  @default(DRAFT)
  feedback    String?
  submittedAt DateTime?
  approvedAt  DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  // Relations
  deal        Deal            @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([status])
}

model Payment {
  id                Int      @id @default(autoincrement())
  dealId            Int      @unique
  amount            Float
  escrowWallet      String
  encryptedKey      String
  status            PaymentStatus @default(PENDING)
  transactionHash   String?
  paidAt            DateTime?
  releasedAt        DateTime?
  refundedAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  deal              Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
}

model Post {
  id                Int      @id @default(autoincrement())
  dealId            Int      @unique
  messageId         String
  channelId         String
  postedAt          DateTime @default(now())
  verificationStartedAt DateTime?
  verifiedAt        DateTime?
  isDeleted         Boolean  @default(false)
  isEdited          Boolean  @default(false)
  lastChecked       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  deal              Deal     @relation(fields: [dealId], references: [id], onDelete: Cascade)
  channel           Channel  @relation(fields: [channelId], references: [telegramChannelId])

  @@index([dealId])
}

